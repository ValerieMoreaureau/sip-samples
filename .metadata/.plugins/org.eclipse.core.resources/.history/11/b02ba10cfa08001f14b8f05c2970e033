package com.mobius.software.oio.multithreading.threadImpl;

import static org.junit.Assert.assertTrue;

import java.io.*;
import java.net.*;
import java.util.concurrent.*;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import com.mobius.software.samples.oio.multiplethreads.threadsImpl.ClientMT;
import com.mobius.software.samples.oio.multiplethreads.threadsImpl.ServerMT;

public class MultithreadingTest {
    private final ByteArrayOutputStream outputStreamCaptor = new ByteArrayOutputStream();
    private final PrintStream standardOut = System.out;

    @Before
    public void setUp() {
        System.setOut(new PrintStream(outputStreamCaptor));
    }

    @After
    public void tearDown() {
        System.setOut(standardOut);
    }

    @Test
    public void testClientServerCommunication() throws IOException, InterruptedException {
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        CountDownLatch latch = new CountDownLatch(3);

        // Start server in a separate thread
        executorService.execute(new ServerTask(latch));

        // Delay to ensure the server starts before the clients
        Thread.sleep(3000);

        // Start multiple clients
        for (int i = 0; i < 2; i++) {
            executorService.execute(new ClientTask(latch, new String[]{"Hello", "How are you?", "BYE"}));
        }

        latch.await();

        // Shutdown executor service
        executorService.shutdown();
        executorService.awaitTermination(1, TimeUnit.MINUTES);

        // Print the communication dialogue to the console
        String consoleOutput = outputStreamCaptor.toString();
        System.out.println("Communication Dialogue:\n" + consoleOutput);

        // Verify the communication by checking the console output
        assertTrue("Console output should contain 'Hello'", consoleOutput.contains("Hello"));
        assertTrue("Console output should contain 'How are you?'", consoleOutput.contains("How are you?"));
        assertTrue("Console output should contain 'BYE'", consoleOutput.contains("BYE"));
        assertTrue("Console output should contain 'Server: MESSAGE RECEIVED'", consoleOutput.contains("Server: MESSAGE RECEIVED"));

        // Add shutdown hook to terminate the program after everything is outputted
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            System.out.println("Program is terminating...");
        }));
    }
}

class ServerTask implements Runnable {
    private final CountDownLatch latch;

    public ServerTask(CountDownLatch latch) {
        this.latch = latch;
    }

    @Override
    public void run() {
        ServerMT server = new ServerMT();
        server.startServer();
        latch.countDown();
    }
}

class ClientTask implements Runnable {
    private final CountDownLatch latch;
    private final String[] messages;

    public ClientTask(CountDownLatch latch, String[] messages) {
        this.latch = latch;
        this.messages = messages;
    }

    @Override
    public void run() {
        try {
            ClientMT client = new ClientMT(messages);
            client.start();
        } finally {
            latch.countDown();
        }
    }
}

